import { mkdir, readFile, writeFile } from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const scriptDir = path.dirname(fileURLToPath(import.meta.url));
const projectRoot = path.resolve(scriptDir, '..');
const srcPath = path.join(projectRoot, 'src', 'data', 'knowledge-base.json');
const outDir = path.join(projectRoot, 'src', 'data', 'knowledge-base');

function normalizeMainTopic(value) {
  const v = typeof value === 'string' ? value.trim() : '';
  return v.length > 0 ? v : 'Uncategorized';
}

function slugify(value) {
  return value
    .toLowerCase()
    .trim()
    .replace(/['"]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '');
}

function toIdentifier(value) {
  const slug = slugify(value);
  const parts = slug.split('-').filter(Boolean);
  const camel = parts
    .map((p, i) => (i === 0 ? p : p.slice(0, 1).toUpperCase() + p.slice(1)))
    .join('');
  const safe = camel.length > 0 ? camel : 'uncategorized';
  return /^[a-zA-Z_$]/.test(safe) ? safe : `kb_${safe}`;
}

const raw = await readFile(srcPath, 'utf8');
const data = JSON.parse(raw);

if (!Array.isArray(data)) {
  throw new Error(`Expected an array in ${srcPath}`);
}

/** @type {Map<string, any[]>} */
const groups = new Map();

for (const entry of data) {
  const mainTopic = normalizeMainTopic(entry?.['main-topic']);
  const next = { ...entry, ['main-topic']: mainTopic };
  const arr = groups.get(mainTopic) ?? [];
  arr.push(next);
  groups.set(mainTopic, arr);
}

await mkdir(outDir, { recursive: true });

const mainTopics = [...groups.keys()].sort((a, b) =>
  a.localeCompare(b, undefined, { sensitivity: 'base' })
);

/** @type {{ mainTopic: string; slug: string; file: string; ident: string }[]} */
const outputs = [];

for (const mainTopic of mainTopics) {
  const slug = slugify(mainTopic);
  const file = `${slug}.json`;
  const ident = toIdentifier(mainTopic);
  const entries = groups.get(mainTopic) ?? [];

  // Stable-ish ordering for nicer diffs
  entries.sort((a, b) => {
    const at = String(a?.topic ?? '');
    const bt = String(b?.topic ?? '');
    const ao = String(a?.object ?? '');
    const bo = String(b?.object ?? '');
    return at.localeCompare(bt) || ao.localeCompare(bo);
  });

  await writeFile(path.join(outDir, file), JSON.stringify(entries, null, 2) + '\n', 'utf8');
  outputs.push({ mainTopic, slug, file, ident });
}

const indexTs = `// Auto-generated by scripts/split-knowledge-base.mjs
// Source: src/data/knowledge-base.json

${outputs.map((o) => `import ${o.ident} from './${o.file}';`).join('\n')}

export const byMainTopic = {
${outputs.map((o) => `  ${JSON.stringify(o.mainTopic)}: ${o.ident},`).join('\n')}
} as const;

export const mainTopics = Object.keys(byMainTopic).sort((a, b) =>
  a.localeCompare(b, undefined, { sensitivity: 'base' })
);

const all = Object.values(byMainTopic).flat();
export default all;
`;

await writeFile(path.join(outDir, 'index.ts'), indexTs, 'utf8');

console.log(`Wrote ${outputs.length} topic files to ${outDir}`);
